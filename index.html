<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>GROKIPEDIA v2.5</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="icon-192.png"/>
  <meta name="theme-color" content="#0a1a2e"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <style>
    :root{--bg:#0a1a2e;--accent:#00aaff;--text:#aaccff;--dark:#112240;--glow:#00aaff;--white:#ffffff}
    body{background:var(--bg);color:var(--accent);font-family:'Courier New',monospace;margin:0;padding:20px;line-height:1.6}
    h1{font-size:2.3em;text-shadow:0 0 15px var(--glow);margin:10px 0 5px;text-align:center}
    h2{font-size:1.1em;color:var(--text);text-align:center;margin-bottom:20px}
    .platform{font-size:.9em;color:#88aaff;font-style:italic;text-align:center;margin:10px 0}
    .input-container{max-width:100%;margin:20px auto}
    input[type="text"]{width:100%;background:var(--dark);color:var(--accent);border:2px solid var(--accent);border-radius:12px;padding:16px;font-size:1.2em;box-shadow:0 0 12px rgba(0,170,255,.3);box-sizing:border-box}
    button{margin:20px auto;display:block;padding:14px 40px;font-size:1.3em;background:var(--accent);color:#000;border:none;border-radius:12px;cursor:pointer;font-weight:bold;box-shadow:0 0 15px rgba(0,170,255,.6)}
    .box{margin:20px 0;background:rgba(17,34,64,.8);border:1px solid var(--accent);border-radius:12px;padding:18px;color:var(--text)}
    .box h3{color:var(--white);border-bottom:1px solid var(--accent);padding-bottom:8px;margin:0 0 12px}
    .entry{margin:15px 0;padding-bottom:12px;border-bottom:1px dashed var(--accent)}
    .entry:last-child{border-bottom:none}
    .bias-meter-container{position:relative;height:20px;background:#111;border-radius:10px;overflow:hidden;margin:10px 0;border:1px solid #00aaff;box-shadow:0 0 10px rgba(0,170,255,.4)}
    .bias-meter{height:100%;width:100%;background:linear-gradient(to right,#ff3333 0%,#ff8833 25%,#cccccc 50%,#33bbff 75%,#3333ff 100%);transition:all .6s}
    .bias-pointer{position:absolute;top:0;left:50%;width:4px;height:100%;background:#fff;box-shadow:0 0 15px #fff;transform:translateX(-50%);transition:left .6s}
    .bias-label{position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);font-size:0.8em;font-weight:bold;color:#fff;text-shadow:0 0 8px #000;white-space:nowrap}
    .loading{color:#ff6666;font-style:italic;text-align:center;padding:20px}
    footer{margin-top:60px;font-size:.8em;color:#5577aa;text-align:center}
    .offline{color:#ff6666;font-style:italic;text-align:center}
  </style>
</head>
<body>
  <h1>GROKIPEDIA <span style="color:#ff3333;">v2.5</span></h1>
  <h2>— Freedom Vortex Fixed —</h2>
  <div class="platform">PWA • Offline • Installable • Bias Meter v2</div>

  <div class="input-container">
    <input type="text" id="search" placeholder="Search public web + #Grokipedia…" autocomplete="off">
  </div>
  <button id="go">ENTER THE VORTEX</button>

  <div id="x-box" class="box"><h3>#GROKIPEDIA X POSTS</h3><div id="x-results">Ready</div></div>
  <div id="web-box" class="box"><h3>WEB RESULTS</h3><div id="web-results">Results load here</div></div>

  <div id="offline" class="offline" style="display:none">Offline – showing cached vortex</div>
  <footer>GROKIPEDIA v2.5 BIAS METER FIX — Freedom Collective • Nov 2025</footer>

  <script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

    // === EXPANDED BIAS DATABASE (100+ sources) ===
    const biasDB = {
      // LEFT
      "cnn.com": -80, "msnbc.com": -85, "huffpost.com": -75, "nytimes.com": -60, "washingtonpost.com": -65,
      "theguardian.com": -70, "vox.com": -75, "slate.com": -70, "motherjones.com": -90, "dailykos.com": -85,
      "jacobinmag.com": -95, "thenation.com": -80, "newyorker.com": -55, "buzzfeednews.com": -70,
      // CENTER-LEFT
      "npr.org": -30, "apnews.com": -20, "reuters.com": -10, "bbc.com": -15, "abcnews.go.com": -35,
      "cbsnews.com": -30, "politico.com": -25, "axios.com": -20,
      // CENTER
      "wsj.com": 0, "newsweek.com": 5, "time.com": 0, "usatoday.com": 10,
      // CENTER-RIGHT
      "foxnews.com": 40, "nypost.com": 50, "dailywire.com": 70, "theblaze.com": 75,
      "nationalreview.com": 60, "washingtonexaminer.com": 55,
      // RIGHT
      "breitbart.com": 85, "newsmax.com": 90, "oann.com": 95, "thefederalist.com": 80,
      "gatewaypundit.com": 90, "infowars.com": 95, "zerohedge.com": 70,
      // NEUTRAL / UNKNOWN
      "wikipedia.org": 0, "medium.com": 0, "youtube.com": 0
    };

    function getBias(domain) {
      domain = domain.toLowerCase().replace(/^www\./, '').split('/')[0];
      let score = biasDB[domain] || 0;
      let lean, pct;
      if (score <= -70) lean = "Far Left";
      else if (score <= -40) lean = "Left";
      else if (score <= -15) lean = "Center-Left";
      else if (score < 15) lean = "Center";
      else if (score < 40) lean = "Center-Right";
      else if (score < 70) lean = "Right";
      else lean = "Far Right";
      pct = Math.round((score + 100) / 2); // -100 → 0%, 0 → 50%, +100 → 100%
      return {lean, pct, score};
    }

    const cache = localStorage;

    async function searchVortex() {
      const term = document.getElementById('search').value.trim();
      if (!term) return;
      const key = 'cache_'+term;
      if (cache.getItem(key)) { render(JSON.parse(cache.getItem(key))); return; }

      document.getElementById('x-results').innerHTML = '<p class="loading">Scraping X RSS…</p>';
      document.getElementById('web-results').innerHTML = '<p class="loading">Scraping web…</p>';

      const xPosts = await fetchXRss('#Grokipedia '+term);
      const webResults = await fetchBrave(term);

      const data = {xPosts, webResults, term, date: Date.now()};
      cache.setItem(key, JSON.stringify(data));
      render(data);
    }

    async function fetchXRss(q) {
      try {
        const rss = `https://x.com/search/rss?q=${encodeURIComponent(q)}`;
        const proxy = `https://corsproxy.io/?${encodeURIComponent(rss)}`;
        const r = await fetch(proxy, {signal: AbortSignal.timeout(9000)});
        const txt = await r.text();
        const doc = new DOMParser().parseFromString(txt, 'text/xml');
        return Array.from(doc.querySelectorAll('item')).slice(0,10).map(i=>({
          title: i.querySelector('title')?.textContent.replace(/^[^:]+: /,'') || '',
          body: i.querySelector('description')?.textContent || '',
          link: i.querySelector('link')?.textContent || '#'
        }));
      } catch { return []; }
    }

    async function fetchBrave(q) {
      try {
        const url = `https://search.brave.com/search?q=${encodeURIComponent(q)}&source=web`;
        const proxy = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        const r = await fetch(proxy, {signal: AbortSignal.timeout(9000)});
        const html = await r.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        return Array.from(doc.querySelectorAll('.snippet')).slice(0,8).map(s=>{
          const a = s.querySelector('a');
          const title = a?.innerText || 'No title';
          const link = a?.href || '#';
          const desc = s.querySelector('.snippet-description')?.innerText || '';
          const domain = new URL(link).hostname.replace('www.','');
          const bias = getBias(domain);
          return {title, body: desc.substring(0,220)+'…', link, domain, bias};
        });
      } catch { return []; }
    }

    function render(data) {
      document.getElementById('offline').style.display = navigator.onLine ? 'none' : 'block';

      // X POSTS – now with proper gradient meter
      document.getElementById('x-results').innerHTML = data.xPosts.length ? data.xPosts.map(p=>`
        <div class="entry"><strong>${p.title}</strong><br>
        <div class="bias-meter-container">
          <div class="bias-meter"></div>
          <div class="bias-pointer" style="left:50%"></div>
          <div class="bias-label">X Platform • Neutral Zone</div>
        </div>
        <small>Bias: Neutral (X post)</small><br>
        <a href="${p.link}" target="_blank" style="color:#00aaff">View →</a></div>`).join('') :
        '<em>No #Grokipedia X posts yet.</em>';

      // WEB RESULTS – full gradient meter with label
      document.getElementById('web-results').innerHTML = data.webResults.length ? data.webResults.map(r=>`
        <div class="entry"><strong>${r.title}</strong><br>
        <div class="bias-meter-container">
          <div class="bias-meter"></div>
          <div class="bias-pointer" style="left:${r.bias.pct}%"></div>
          <div class="bias-label">${r.bias.lean} (${r.bias.score}) – ${r.domain}</div>
        </div>
        <p>${r.body}</p>
        <a href="${r.link}" target="_blank" style="color:#00aaff">Visit →</a></div>`).join('') :
        '<em>No web results – check connection.</em>';
    }

    document.getElementById('go').onclick = searchVortex;
    document.getElementById('search').onkeydown = e => {if(e.key==='Enter') searchVortex();};

    // Load last search
    const last = Object.keys(cache).filter(k=>k.startsWith('cache_')).sort((a,b)=>JSON.parse(cache.getItem(b)).date - JSON.parse(cache.getItem(a)).date)[0];
    if (last) render(JSON.parse(cache.getItem(last)));
  </script>
</body>
</html>
